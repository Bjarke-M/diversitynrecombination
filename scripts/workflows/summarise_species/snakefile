# a snakemake workflow for summarising the species level results from my pi-estimation and recombination estimation

input_file = '/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/data/PDGP_metadata.txt'
def generatedictionary(input):
    dictionary_of_species_n_pdid = {}
    with open(input_file, 'r') as file:
        header = next(file)  # Read and skip the header line
        for line in file:
            fields = line.strip().split(',')
            pdgp_id, genus, species, froh, sex, ref_assembly = fields
            if not ref_assembly:  # Check if ref_assembly is empty
                ref_assembly = 'unknown'
            # Add the pdgp_id to the appropriate category in the dictionary
            if ref_assembly not in dictionary_of_species_n_pdid:
                dictionary_of_species_n_pdid[ref_assembly] = {species: [pdgp_id]}
            elif species not in dictionary_of_species_n_pdid[ref_assembly]:
                dictionary_of_species_n_pdid[ref_assembly][species] = [pdgp_id]
            else:
                dictionary_of_species_n_pdid[ref_assembly][species].append(pdgp_id)
    return dictionary_of_species_n_pdid 


def generate_output_paths(species_list, window_list):
    input_paths = []
    for ref_assembly in species_list:
        for species in dictionary_of_inds[ref_assembly]:
            for window_size in window_list:
                input_paths.append(f'/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/results/callable_fraction/{ref_assembly}/{species}/{window_size}_callable_fraction.csv')
    return input_paths

def generate_list_of_pds(species_list):
    pd_list = {}
    for ref_assembly in species_list:
        for species in dictionary_of_inds[ref_assembly]:
            for pd in dictionary_of_inds[ref_assembly][species]:
                if ref_assembly not in pd_list:
                    pd_list[ref_assembly] = [pd]
                else:
                    pd_list[ref_assembly].append(pd)
    return pd_list

def generate_input_paths(species_list, window_list):
    input_paths = []
    for ref_assembly in species_list:
        for pd in pd_list[ref_assembly]:
            for window_size in window_list:
                input_paths.append(f'/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/data/mask/{ref_assembly}/{pd}/csv/{pd}_masked_{window_size}.csv')
    return input_paths



dictionary_of_inds = generatedictionary(input_file)
#window_list = [1000000]
window_list = [1000, 5000, 10000, 50000, 100000, 500000, 1000000, 2000000, 10000000]
species_list = ['Pongo_abelii']
# species_list = ['Daubentonia_madagascariensis','Saguinus_midas','Chlorocebus_aethiops',
#                 'Rhinopithecus_roxellana','Mandrillus_sphinx','Macaca_mulatta','Loris_tardigradus','Callithrix_jacchus',
#                 'Pithecia_pithecia','Lemur_catta-Thomas','Gorilla_gorilla_gorilla','Aotus_nancymaae','Sapajus_apella',
#                 'Pongo_abelii','Cercocebus_atys','Galago_moholi','Nomascus_leucogenys','Colobus_guereza',
#                 'Cebus_albifrons','Cercopithecus_mitis','Pongo_pygmaeus','Pan_troglodytes','Erythrocebus_patas',
#                 'Microcebus_murinus','Atele_fusciceps','Otolemur_garnettii','Nycticebus_pygmaeus']
#Missing g.vcf.gz species: Theropithecus_gelada
#Missing chainfiles: Carlito_syrichta Propithecus_coquereli'
pd_list= generate_list_of_pds(species_list)

rule all:
    input:
        expand(generate_output_paths(species_list, window_list=window_list))


rule summarise_callable_fraction:
    input:
        expand(generate_input_paths(species_list,window_list)) #checks wheter all files exist not just the specific window_size it will generate the output for in each iteration
    output:
        output='/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/results/callable_fraction/{ref_assembly}/{species}/{window_size}_callable_fraction.csv'
    params:
        ref_assembly='{ref_assembly}',
        species='{species}',
        window_size='{window_size}'
    conda:
        '/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/scripts/workflows/summarise_species/envs/pandas.yaml'
    script:
        '/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/scripts/workflows/summarise_species/summarise_callable_fraction.py {params.ref_assembly} {params.species} {params.window_size}' 


# rule combine_species:
#     input:
#         callable_fraction = '/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/results/callable_fraction/{ref_assembly}/{species}/{window_size}_callable_fraction.csv',
#         pi_estimation = '/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/results/windowed_pi/{ref_assembly}/{species}/nonpar/{species}_{window_size}.windowed.pi'
#     output:
#         output='/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/results/combined/{ref_assembly}/{species}/{species}_{window_size}_combined.csv'
#     conda:
#         '/home/bjarkemp/primatediversity/people/bjarkemp/diversitynrecombination/scripts/workflows/summarise_species/envs/pandas.yaml'
#     script:
#         #some script
# # this rule should combine the species sepcifik pi estimation and the callabla fraction for each species
